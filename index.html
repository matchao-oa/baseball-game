<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë©€í‹° ìˆ«ì ì•¼êµ¬</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #f0f8f5; padding-top: 50px; }
        .container { background: white; padding: 20px; border-radius: 15px; display: inline-block; box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 350px; }
        input { padding: 10px; font-size: 16px; width: 120px; border: 2px solid #3cb371; border-radius: 5px; margin-bottom: 10px; }
        button { padding: 10px 20px; font-size: 16px; background-color: #ddffdd; color: #444447; border: none; border-radius: 5px; cursor: pointer; margin: 5px; font-weight: bold; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin: 20px; font-weight: bold; color: #2e8b57; min-height: 40px; }
        #log { margin-top: 20px; text-align: left; height: 150px; overflow-y: auto; padding: 10px; border-top: 1px solid #eee; font-size: 13px; background: #fafafa; }
        .win-msg { color: #d9534f; font-size: 18px; }
        .room-info { background: #e8f5e9; padding: 10px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <h2>âš¾ï¸ ë©€í‹° ìˆ«ì ì•¼êµ¬</h2>
    
    <div id="setup-area">
        <button onclick="createNewRoom()">ìƒˆ ë°© ë§Œë“¤ê¸°</button>
        <div style="margin: 15px 0; color: #888;">--- ë˜ëŠ” ---</div>
        <input type="text" id="roomCodeInput" placeholder="ë°© ë²ˆí˜¸ 4ìë¦¬">
        <button onclick="joinExistingRoom()">ë°© ì…ì¥í•˜ê¸°</button>
    </div>

    <div id="game-area" style="display:none;">
        <div class="room-info">ë°© ë²ˆí˜¸: <span id="displayRoomCode" style="font-weight:bold; color: #2e8b57;"></span></div>
        <div id="status">ëŒ€ê¸° ì¤‘...</div>
        <div id="input-section">
            <input type="text" id="numberInput" maxlength="3" placeholder="3ìë¦¬ ìˆ«ì">
            <button id="actionBtn" onclick="handleAction()">í™•ì¸</button>
        </div>
        <div id="log"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBUAnG4KmuGAY0JCVzreb0o5XZd4qjJAZA",
        authDomain: "bullsandcows1004.firebaseapp.com",
        databaseURL: "https://bullsandcows1004-default-rtdb.firebaseio.com",
        projectId: "bullsandcows1004",
        storageBucket: "bullsandcows1004.firebasestorage.app",
        messagingSenderId: "191843667458",
        appId: "1:191843667458:web:a01e29f4883e8168e2211b",
        measurementId: "G-48WXZP73B7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myRole = ""; 
    let currentRoomId = ""; 
    let gameState = {};

    // 1. ìƒˆ ë°© ë§Œë“¤ê¸°
    function createNewRoom() {
        const randomCode = Math.floor(1000 + Math.random() * 9000).toString();
        currentRoomId = randomCode;
        myRole = "player1";
        
        db.ref('rooms/' + currentRoomId + '/player1').set({ id: "p1", ready: false })
          .then(() => startUI(randomCode));
    }

    // 2. ê¸°ì¡´ ë°© ì…ì¥í•˜ê¸°
    function joinExistingRoom() {
        const code = document.getElementById('roomCodeInput').value;
        if (code.length < 4) return alert("ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        
        db.ref('rooms/' + code).get().then((snapshot) => {
            const data = snapshot.val();
            if (!data) return alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.");
            if (data.player2) return alert("ì´ë¯¸ ê°€ë“ ì°¬ ë°©ì…ë‹ˆë‹¤.");
            
            currentRoomId = code;
            myRole = "player2";
            db.ref('rooms/' + currentRoomId + '/player2').set({ id: "p2", ready: false })
              .then(() => startUI(code));
        });
    }

    function startUI(code) {
        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        document.getElementById('displayRoomCode').innerText = code;
        listenGame();
    }

    function listenGame() {
        db.ref('rooms/' + currentRoomId).on('value', (snapshot) => {
            gameState = snapshot.val();
            const status = document.getElementById('status');
            const btn = document.getElementById('actionBtn');
            const inputSection = document.getElementById('input-section');

            if (!gameState) {
                if (status.innerText.includes("ìŠ¹ë¦¬")) return;
                status.innerHTML = "<span class='win-msg'>ìƒëŒ€ë°©ì´ ì •ë‹µì„ ë§í˜”ìŠµë‹ˆë‹¤! ğŸ˜­</span><br><button onclick='location.reload()'>ì´ˆê¸°í™”ë©´ìœ¼ë¡œ</button>";
                inputSection.style.display = 'none';
                return;
            }

            if (!gameState.player2) {
                status.innerText = "ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘... (ë°© ë²ˆí˜¸ë¥¼ ê³µìœ í•˜ì„¸ìš”)";
                btn.disabled = true;
            } else if (!gameState.player1.ready || !gameState.player2.ready) {
                const myReady = gameState[myRole].ready;
                status.innerText = myReady ? "ìƒëŒ€ë°©ì´ ìˆ«ìë¥¼ ê³ ë¥´ê³  ìˆìŠµë‹ˆë‹¤..." : "ìˆ¨ê¸¸ ë‚˜ì˜ ìˆ«ìë¥¼ ì •í•˜ì„¸ìš”!";
                btn.disabled = myReady;
                btn.innerText = "ìˆ«ì ì„¤ì •";
            } else {
                btn.innerText = "ê³µê²©!";
                if (gameState.turn === myRole) {
                    status.innerText = "ğŸ”¥ ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤!";
                    btn.disabled = false;
                } else {
                    status.innerText = "ğŸ’¤ ìƒëŒ€ë°©ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤...";
                    btn.disabled = true;
                }
            }
        });
    }

    function handleAction() {
        const val = document.getElementById('numberInput').value;
        if (val.length !== 3 || isNaN(val)) return alert("3ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”!");

        if (!gameState[myRole].ready) {
            db.ref('rooms/' + currentRoomId + '/' + myRole).update({ ready: true, secret: val });
            if (myRole === "player2") db.ref('rooms/' + currentRoomId).update({ turn: "player1" });
            document.getElementById('numberInput').value = "";
            addLog(`âœ… ìˆ˜ë¹„ ìˆ«ì [${val}] ì„¤ì • ì™„ë£Œ!`);
        } else {
            const opponentRole = myRole === "player1" ? "player2" : "player1";
            const target = gameState[opponentRole].secret;
            const result = checkScore(val, target);
            
            addLog(`ğŸš€ ê³µê²© [${val}]: ${result}`);
            
            if (result === "3S 0B (í™ˆëŸ°!)") {
                document.getElementById('status').innerHTML = "<span class='win-msg'>ğŸ‰ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!</span><br><button onclick='location.reload()'>ìƒˆ ê²Œì„</button>";
                document.getElementById('input-section').style.display = 'none';
                db.ref('rooms/' + currentRoomId).remove(); 
            } else {
                db.ref('rooms/' + currentRoomId).update({ turn: opponentRole });
            }
            document.getElementById('numberInput').value = "";
        }
    }

    function checkScore(input, target) {
        let s = 0, b = 0;
        for (let i = 0; i < 3; i++) {
            if (input[i] === target[i]) s++;
            else if (target.includes(input[i])) b++;
        }
        if (s === 3) return "3S 0B (í™ˆëŸ°!)";
        return `${s}S ${b}B`;
    }

    function addLog(msg) {
        const log = document.getElementById('log');
        log.innerHTML = `<div>${msg}</div>` + log.innerHTML;
    }
</script>

</body>
</html>