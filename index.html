<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë©€í‹° ìˆ«ì ì•¼êµ¬ Pro - Final Fixed</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --bg-color: #f0f8f5;
            --container-bg: #C1B098;
            --point-color: #DBDBDB;
            --btn-bg: #FBF2C0;
            --btn-text: #48392A;
            --text-color: #48392A;
            --accent-color: #d9534f;
        }

        body { font-family: 'Pretendard', sans-serif; text-align: center; background-color: var(--bg-color); margin: 0; padding: 20px; box-sizing: border-box; color: var(--text-color); }
        .container { background: var(--container-bg); padding: 25px 15px; border-radius: 25px; max-width: 400px; margin: 0 auto; box-shadow: 0 12px 30px rgba(0,0,0,0.15); }
        h2 { color: var(--text-color); margin-bottom: 20px; font-size: 26px; }
        .setup-box, .room-info { margin-bottom: 15px; background: var(--point-color); padding: 18px; border-radius: 15px; border: 1px solid rgba(0,0,0,0.05); color: var(--text-color); }
        label { font-size: 14px; display: block; margin-bottom: 8px; font-weight: bold; }
        input, select { padding: 15px; font-size: 18px; width: 85%; max-width: 220px; border: none; border-radius: 12px; margin-bottom: 10px; outline: none; text-align: center; background: white; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        button { padding: 16px 20px; font-size: 16px; background-color: var(--btn-bg) !important; color: var(--btn-text) !important; border: 1px solid rgba(0,0,0,0.1) !important; border-radius: 14px; cursor: pointer; margin: 8px; font-weight: bold; width: 90%; transition: all 0.2s ease; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        button:active { transform: translateY(2px); box-shadow: none; }
        button:disabled { background-color: #bbb !important; color: #777 !important; transform: none; box-shadow: none; cursor: not-allowed; }
        #status { margin: 20px 0; font-weight: bold; min-height: 70px; font-size: 18px; line-height: 1.4; }
        #log { margin-top: 20px; text-align: left; height: 180px; overflow-y: auto; padding: 15px; border-radius: 15px; font-size: 14px; background: rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.5); }
        .win-msg { color: var(--accent-color); font-size: 22px; font-weight: 800; display: block; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>âš¾ï¸ ë©€í‹° ìˆ«ì ì•¼êµ¬ âš¾ï¸</h2>
    <div id="setup-area">
        <div class="setup-box">
            <label>ë‚œì´ë„ ì„ íƒ</label>
            <select id="digitSelect">
                <option value="3">3ìë¦¬ (ë³´í†µ)</option>
                <option value="4">4ìë¦¬ (ì–´ë ¤ì›€)</option>
                <option value="5">5ìë¦¬ (ì§€ì˜¥)</option>
            </select>
            <button onclick="createNewRoom()">ìƒˆ ë°© ë§Œë“¤ê¸°</button>
        </div>
        <div style="margin: 15px 0; font-weight: bold; opacity: 0.7;">OR</div>
        <div class="setup-box">
            <input type="tel" id="roomCodeInput" maxlength="4" placeholder="ë°© ë²ˆí˜¸ 4ìë¦¬">
            <button onclick="joinExistingRoom()">ì…ì¥í•˜ê¸°</button>
        </div>
    </div>
    <div id="game-area" style="display:none;">
        <div class="room-info">ë°© ë²ˆí˜¸: <span id="displayRoomCode" style="font-weight:900;"></span> | <span id="displayDigits" style="font-weight:900; color: var(--accent-color);"></span>ìë¦¬ ëª¨ë“œ</div>
        <div id="status">ëŒ€ê¸° ì¤‘...</div>
        <div id="input-section">
            <input type="tel" id="numberInput" inputmode="numeric" placeholder="ìˆ«ì ì…ë ¥">
            <button id="actionBtn" onclick="handleAction()">í™•ì¸</button>
        </div>
        <div id="log"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBUAnG4KmuGAY0JCVzreb0o5XZd4qjJAZA",
        authDomain: "bullsandcows1004.firebaseapp.com",
        databaseURL: "https://bullsandcows1004-default-rtdb.firebaseio.com",
        projectId: "bullsandcows1004",
        storageBucket: "bullsandcows1004.firebasestorage.app",
        messagingSenderId: "191843667458",
        appId: "1:191843667458:web:a01e29f4883e8168e2211b",
        measurementId: "G-48WXZP73B7"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myRole = "", currentRoomId = "", gameState = {}, digits = 3, lastTurn = "";
    let tryCount = 0;
    let isGameOver = false; // ìŠ¹íŒ¨ êµ¬ë¶„ìš© ë³€ìˆ˜ ì¶”ê°€

    function playSound(type) {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (type === 'turn') {
            [1046.50, 1567.98].forEach((f, i) => {
                const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                o.type = 'sine'; o.frequency.setValueAtTime(f, audioCtx.currentTime + (i * 0.08));
                g.gain.setValueAtTime(0.1, audioCtx.currentTime + (i * 0.08));
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + (i * 0.08) + 0.1);
                o.connect(g); g.connect(audioCtx.destination); o.start(audioCtx.currentTime + (i * 0.08)); o.stop(audioCtx.currentTime + (i * 0.08) + 0.1);
            });
        } else if (type === 'win') {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = 'sawtooth'; o.frequency.setValueAtTime(220, audioCtx.currentTime); 
            o.frequency.exponentialRampToValueAtTime(1320, audioCtx.currentTime + 0.8); 
            g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.2);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + 1.2);
        }
    }

    function createNewRoom() {
        const code = Math.floor(1000 + Math.random() * 9000).toString();
        digits = parseInt(document.getElementById('digitSelect').value);
        currentRoomId = code; myRole = "player1";
        db.ref('rooms/' + code).set({ digits, player1: { id: "p1", ready: false } }).then(() => startUI(code, digits));
    }

    function joinExistingRoom() {
        const code = document.getElementById('roomCodeInput').value;
        if (code.length < 4) return alert("ë°© ë²ˆí˜¸ 4ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        db.ref('rooms/' + code).get().then((s) => {
            const d = s.val();
            if (!d) return alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.");
            if (d.player2) return alert("ì´ë¯¸ ëŒ€ê²° ì¤‘ì¸ ë°©ì…ë‹ˆë‹¤.");
            currentRoomId = code; myRole = "player2"; digits = d.digits;
            db.ref('rooms/' + code + '/player2').set({ id: "p2", ready: false }).then(() => startUI(code, digits));
        });
    }

    function startUI(c, d) {
        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        document.getElementById('displayRoomCode').innerText = c;
        document.getElementById('displayDigits').innerText = d;
        document.getElementById('numberInput').maxLength = d;
        listenGame();
    }

    function listenGame() {
        db.ref('rooms/' + currentRoomId).on('value', (s) => {
            if (isGameOver) return; // ë‚´ê°€ ì´ë¯¸ ì´ê²¼ë‹¤ë©´ ë” ì´ìƒ ì—…ë°ì´íŠ¸ ì•ˆ í•¨

            gameState = s.val();
            const status = document.getElementById('status'), btn = document.getElementById('actionBtn'), inputSection = document.getElementById('input-section');
            
            if (!gameState) {
                // ë°© ë°ì´í„°ê°€ ì‚¬ë¼ì¡ŒëŠ”ë°, ë‚´ê°€ ì´ê¸´ ê²Œ ì•„ë‹ˆë¼ë©´ ìƒëŒ€ê°€ ì´ê¸´ ê²ƒì„
                status.innerHTML = "<span class='win-msg'>ìƒëŒ€ë°©ì´ ì •ë‹µì„ ë§í˜”ìŠµë‹ˆë‹¤! ğŸ˜­</span><button onclick='location.reload()'>ë©”ì¸ìœ¼ë¡œ</button>";
                inputSection.style.display = 'none'; 
                return;
            }

            if (!gameState.player2) {
                status.innerText = "ìƒëŒ€ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...\në°© ë²ˆí˜¸ ["+currentRoomId+"]ë¥¼ ê³µìœ í•˜ì„¸ìš”!";
                btn.disabled = true;
            } else if (!gameState.player1.ready || !gameState.player2.ready) {
                const myReady = gameState[myRole].ready;
                status.innerText = myReady ? "ìƒëŒ€ë°©ì´ ìˆ«ìë¥¼ ê³ ë¥´ê³  ìˆì–´ìš”..." : "ìƒëŒ€ì—ê²Œ ìˆ¨ê¸¸\n"+digits+"ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”!";
                btn.disabled = myReady; btn.innerText = "ìˆ«ì ì„¤ì • ì™„ë£Œ";
            } else {
                btn.innerText = "ê³µê²©!";
                if (gameState.turn === myRole) {
                    status.innerText = "ğŸ”¥ ë‚´ ì°¨ë¡€ì…ë‹ˆë‹¤! (ê³µê²© "+(tryCount+1)+"íšŒì°¨)\nì •ë‹µì„ ì¶”ì¸¡í•´ë³´ì„¸ìš”."; btn.disabled = false;
                    if (lastTurn !== myRole) { playSound('turn'); lastTurn = myRole; }
                } else {
                    status.innerText = "ğŸ’¤ ìƒëŒ€ë°©ì˜ ì°¨ë¡€...\nì‹ ì¤‘í•˜ê²Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."; btn.disabled = true; lastTurn = gameState.turn;
                }
            }
        });
    }

    function handleAction() {
        const val = document.getElementById('numberInput').value;
        if (val.length !== digits || isNaN(val)) return alert(digits + "ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
        
        if (!gameState[myRole].ready) {
            db.ref('rooms/' + currentRoomId + '/' + myRole).update({ ready: true, secret: val });
            if (myRole === "player2") db.ref('rooms/' + currentRoomId).update({ turn: "player1" });
            document.getElementById('numberInput').value = "";
            addLog(`âœ… ë‚´ ìˆ˜ë¹„ ìˆ«ì [${val}] ì„¤ì • ì™„ë£Œ`);
        } else {
            const opp = myRole === "player1" ? "player2" : "player1";
            tryCount++;
            const res = checkScore(val, gameState[opp].secret);
            addLog(`ğŸš€ ${tryCount}íšŒì°¨ ê³µê²© [${val}]: ${res}`);
            
            if (res === digits + "S 0B (í™ˆëŸ°!)") {
                isGameOver = true; // ë‚´ê°€ ì´ê²¼ìŒì„ í‘œì‹œ
                playSound('win');
                document.getElementById('status').innerHTML = `<span class='win-msg'>ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ${tryCount}ë²ˆ ë§Œì— í™ˆëŸ°!</span><button onclick='location.reload()'>ìƒˆ ê²Œì„ í•˜ê¸°</button>`;
                document.getElementById('input-section').style.display = 'none';
                db.ref('rooms/' + currentRoomId).remove(); 
            } else {
                db.ref('rooms/' + currentRoomId).update({ turn: opp });
            }
            document.getElementById('numberInput').value = "";
        }
    }

    function checkScore(input, target) {
        let s = 0, b = 0;
        for (let i = 0; i < digits; i++) {
            if (input[i] === target[i]) s++;
            else if (target.includes(input[i])) b++;
        }
        return s === digits ? digits + "S 0B (í™ˆëŸ°!)" : `${s}S ${b}B`;
    }

    function addLog(msg) {
        const log = document.getElementById('log');
        log.innerHTML = `<div>${msg}</div>` + log.innerHTML;
    }
</script>
</body>
</html>