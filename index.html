<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë©€í‹° ìˆ«ì ì•¼êµ¬</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; text-align: center; background-color: #f0f8f5; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { background: white; padding: 25px 15px; border-radius: 20px; display: block; max-width: 400px; margin: 0 auto; box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        h2 { color: #2e8b57; margin-bottom: 25px; font-size: 24px; }
        
        /* ëª¨ë°”ì¼ì—ì„œ ëˆ„ë¥´ê¸° í¸í•œ í° ì…ë ¥ì°½ê³¼ ë²„íŠ¼ */
        input { padding: 15px; font-size: 18px; width: 80%; max-width: 200px; border: 2px solid #e0e0e0; border-radius: 12px; margin-bottom: 15px; outline: none; transition: 0.3s; }
        input:focus { border-color: #3cb371; }
        
        button { padding: 15px 25px; font-size: 16px; background-color: #3cb371; color: white; border: none; border-radius: 12px; cursor: pointer; margin: 8px; font-weight: bold; width: 85%; max-width: 250px; transition: 0.2s; }
        button:active { transform: scale(0.98); background-color: #2e8b57; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        #setup-area button { background-color: #ffffff; color: #3cb371; border: 2px solid #3cb371; }
        #setup-area button:first-child { background-color: #3cb371; color: white; }

        #status { margin: 20px 0; font-weight: bold; color: #2e8b57; min-height: 50px; font-size: 17px; line-height: 1.4; }
        #log { margin-top: 25px; text-align: left; height: 180px; overflow-y: auto; padding: 15px; border-radius: 12px; font-size: 14px; background: #f9f9f9; border: 1px solid #eee; }
        .win-msg { color: #d9534f; font-size: 18px; display: block; margin-bottom: 10px; }
        .room-info { background: #e8f5e9; padding: 12px; border-radius: 12px; margin-bottom: 20px; font-size: 15px; color: #2e8b57; }
    </style>
</head>
<body>

<div class="container">
    <h2>âš¾ï¸ ë©€í‹° ìˆ«ì ì•¼êµ¬</h2>
    
    <div id="setup-area">
        <button onclick="createNewRoom()">ìƒˆ ë°© ë§Œë“¤ê¸°</button>
        <div style="margin: 15px 0; color: #aaa; font-size: 14px;">ë˜ëŠ”</div>
        <input type="tel" id="roomCodeInput" pattern="[0-9]*" inputmode="numeric" maxlength="4" placeholder="ë°© ë²ˆí˜¸ 4ìë¦¬">
        <button onclick="joinExistingRoom()">ë°© ì…ì¥í•˜ê¸°</button>
    </div>

    <div id="game-area" style="display:none;">
        <div class="room-info">ë°© ë²ˆí˜¸: <span id="displayRoomCode" style="font-weight:bold;"></span></div>
        <div id="status">ëŒ€ê¸° ì¤‘...</div>
        <div id="input-section">
            <input type="tel" id="numberInput" pattern="[0-9]*" inputmode="numeric" maxlength="3" placeholder="3ìë¦¬ ìˆ«ì ì…ë ¥">
            <button id="actionBtn" onclick="handleAction()">í™•ì¸</button>
        </div>
        <div id="log"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBUAnG4KmuGAY0JCVzreb0o5XZd4qjJAZA",
        authDomain: "bullsandcows1004.firebaseapp.com",
        databaseURL: "https://bullsandcows1004-default-rtdb.firebaseio.com",
        projectId: "bullsandcows1004",
        storageBucket: "bullsandcows1004.firebasestorage.app",
        messagingSenderId: "191843667458",
        appId: "1:191843667458:web:a01e29f4883e8168e2211b",
        measurementId: "G-48WXZP73B7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myRole = ""; 
    let currentRoomId = ""; 
    let gameState = {};

    function createNewRoom() {
        const randomCode = Math.floor(1000 + Math.random() * 9000).toString();
        currentRoomId = randomCode;
        myRole = "player1";
        db.ref('rooms/' + currentRoomId + '/player1').set({ id: "p1", ready: false }).then(() => startUI(randomCode));
    }

    function joinExistingRoom() {
        const code = document.getElementById('roomCodeInput').value;
        if (code.length < 4) return alert("ë°© ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        db.ref('rooms/' + code).get().then((snapshot) => {
            const data = snapshot.val();
            if (!data) return alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì…ë‹ˆë‹¤.");
            if (data.player2) return alert("ê°€ë“ ì°¬ ë°©ì…ë‹ˆë‹¤.");
            currentRoomId = code;
            myRole = "player2";
            db.ref('rooms/' + currentRoomId + '/player2').set({ id: "p2", ready: false }).then(() => startUI(code));
        });
    }

    function startUI(code) {
        document.getElementById('setup-area').style.display = 'none';
        document.getElementById('game-area').style.display = 'block';
        document.getElementById('displayRoomCode').innerText = code;
        listenGame();
    }

    function listenGame() {
        db.ref('rooms/' + currentRoomId).on('value', (snapshot) => {
            gameState = snapshot.val();
            const status = document.getElementById('status');
            const btn = document.getElementById('actionBtn');
            const inputSection = document.getElementById('input-section');

            if (!gameState) {
                if (status.innerText.includes("ìŠ¹ë¦¬")) return;
                status.innerHTML = "<span class='win-msg'>ìƒëŒ€ë°©ì´ ë§í˜”ìŠµë‹ˆë‹¤! ğŸ˜­</span><button onclick='location.reload()'>ì²˜ìŒìœ¼ë¡œ</button>";
                inputSection.style.display = 'none';
                return;
            }

            if (!gameState.player2) {
                status.innerText = "ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”...\në°© ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”!";
                btn.disabled = true;
            } else if (!gameState.player1.ready || !gameState.player2.ready) {
                const myReady = gameState[myRole].ready;
                status.innerText = myReady ? "ìƒëŒ€ë°©ì˜ ì„ íƒì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..." : "ìƒëŒ€ë°©ì—ê²Œ ìˆ¨ê¸¸\në‚˜ì˜ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”!";
                btn.disabled = myReady;
                btn.innerText = "ìˆ«ì ì„¤ì • ì™„ë£Œ";
            } else {
                btn.innerText = "ê³µê²©!";
                if (gameState.turn === myRole) {
                    status.innerText = "ğŸ”¥ ë‹¹ì‹ ì˜ ì°¨ë¡€ì…ë‹ˆë‹¤!\nìˆ«ìë¥¼ ë§ì¶°ë³´ì„¸ìš”.";
                    btn.disabled = false;
                } else {
                    status.innerText = "ğŸ’¤ ìƒëŒ€ë°© ì°¨ë¡€ì…ë‹ˆë‹¤...\nì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";
                    btn.disabled = true;
                }
            }
        });
    }

    function handleAction() {
        const val = document.getElementById('numberInput').value;
        if (val.length !== 3 || isNaN(val)) return alert("3ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”!");

        if (!gameState[myRole].ready) {
            db.ref('rooms/' + currentRoomId + '/' + myRole).update({ ready: true, secret: val });
            if (myRole === "player2") db.ref('rooms/' + currentRoomId).update({ turn: "player1" });
            document.getElementById('numberInput').value = "";
            addLog(`âœ… ë‚´ ìˆ˜ë¹„ ìˆ«ì [${val}] ì„¤ì •`);
        } else {
            const opponentRole = myRole === "player1" ? "player2" : "player1";
            const target = gameState[opponentRole].secret;
            const result = checkScore(val, target);
            addLog(`ğŸš€ ê³µê²© [${val}]: ${result}`);
            if (result === "3S 0B (í™ˆëŸ°!)") {
                document.getElementById('status').innerHTML = "<span class='win-msg'>ğŸ‰ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!</span><button onclick='location.reload()'>ìƒˆ ê²Œì„ í•˜ê¸°</button>";
                document.getElementById('input-section').style.display = 'none';
                db.ref('rooms/' + currentRoomId).remove(); 
            } else {
                db.ref('rooms/' + currentRoomId).update({ turn: opponentRole });
            }
            document.getElementById('numberInput').value = "";
        }
    }

    function checkScore(input, target) {
        let s = 0, b = 0;
        for (let i = 0; i < 3; i++) {
            if (input[i] === target[i]) s++;
            else if (target.includes(input[i])) b++;
        }
        if (s === 3) return "3S 0B (í™ˆëŸ°!)";
        return `${s}S ${b}B`;
    }

    function addLog(msg) {
        const log = document.getElementById('log');
        log.innerHTML = `<div>${msg}</div>` + log.innerHTML;
    }
</script>

</body>
</html>